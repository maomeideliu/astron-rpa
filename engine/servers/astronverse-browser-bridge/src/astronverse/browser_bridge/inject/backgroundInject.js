const e={getNavigatorUserAgent(){const e=/Chrome/.test(navigator.userAgent),t=/Firefox/.test(navigator.userAgent),a=/Edg/.test(navigator.userAgent);return t?"$firefox$":a?"$edge$":e?"$chrome$":"$unknown$"},wait:async e=>new Promise(t=>{setTimeout(t,1e3*e)}),removeUrlParams:e=>e.replace(/\?.*$/,""),isEndWithSlash:e=>e.endsWith?e.endsWith("/"):"/"===e.substr(-1),stringToRegex(e){let t=e,a="";const n=e.lastIndexOf("/");e.startsWith("/")&&n>0&&(t=e.slice(1,n),t.startsWith("^")&&t.endsWith("$")&&(t=t.slice(1,-1)),(t.includes("\\d")||t.includes("\\w")||t.includes("\\s")||t.includes("\\b")||t.includes("\\.")||t.includes("\\*")||t.includes("\\?")||t.includes("\\+")||t.includes("\\{")||t.includes("\\}")||t.includes("\\[")||t.includes("\\]"))&&(t=t.replace(/\\/g,"\\")),a=e.slice(n+1));try{return new RegExp(t,a)}catch{throw new Error("Invalid regular expression pattern")}},isSupportProtocal:e=>!!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("ftp://")||e.startsWith("file://")),isNumberStartString:e=>/^\d/.test(e),isNumberString:e=>/\d/.test(e),isSpecialCharacter(e){return!!this.isNumberStartString(e)||!!/[~`!@#$%^&*()+\-={}\\[\]|:;"'<>,.?/（）￥！、；：“”‘’【】《》，。？]/.test(e)},success:(e,t="success")=>({code:"0000",data:e,msg:t}),fail:(e="failed",t="5001")=>({code:t,msg:e}),result:(e,t="success",a="0000")=>({code:a,data:e,msg:t})},t={getCookie:t=>new Promise(a=>{t.url||a(e.fail("缺少url字段！")),t.name?chrome.cookies.get(t,t=>{a(e.success(t))}):chrome.cookies.getAll({url:t.url},t=>{a(e.success(t))})}),removeCookie:t=>new Promise(a=>{t.url||a(e.fail("缺少url字段！")),t.name||a(e.fail("缺少name字段！")),chrome.cookies.remove(t,()=>{a(e.success("删除成功"))})}),setCookies:t=>new Promise(a=>{if(Array.isArray(t)){const n=t.map(t=>new Promise(n=>{const{name:r,url:i,path:s,value:c,domain:l,expirationDate:o}=t;i||a(e.fail("缺少url字段！")),r&&c||a(e.fail("缺少必填字段name, value！"));const d={name:r,value:c,url:i,domain:l,expirationDate:o,path:s};chrome.cookies.set(d,()=>{n(!0)})}));Promise.all(n).then(()=>{a(e.success("设置成功"))})}else t.url||a(e.fail("缺少url字段！")),t.name&&t.value||a(e.fail("缺少必填字段name, value！")),chrome.cookies.set(t,()=>{a(e.success("设置成功"))})})};class a{constructor(e,t,a){if(this.produceType=a,"table"===a&&(this.data={...e,produceType:a,values:t}),"similar"===a){const n={...e,value:t};this.data={produceType:a,values:[n]}}}getTable(){return this.data}isSimilarDataType(){return"similar"===this.produceType}}function getSimilarElement(e,t){if(!function(e,t){var a,n;const{xpath:r,cssSelector:i,pathDirs:s}=e,{xpath:c,cssSelector:l,pathDirs:o}=t,d=r.split("/"),u=c.split("/"),m=i.split(">"),h=l.split(">");if(e.url!==t.url)return!1;if(d.length!==u.length)return!1;if(d.length===u.length)for(let w=0;w<d.length;w++){const e=null==(a=d[w])?void 0:a.split("[")[0],t=null==(n=u[w])?void 0:n.split("[")[0];if(e!==t&&"*"!==e&&"*"!==t)return!1}if(m.length!==h.length)return!1;if(s.length!==o.length)return!1;return!0}(e,t))return!1;const a=function(e,t){var a;if(e===t)return e;const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length;s++)n[s]!==r[s]&&(n[s]=null==(a=n[s])?void 0:a.split("[")[0]);const i=n.join("/");return i}(e.xpath,t.xpath),n=function(e,t){if(e===t)return e;const a=e.split(">"),n=t.split(">");for(let r=0;r<a.length;r++)a[r]!==n[r]&&a[r].includes(":nth-child")&&(a[r]=a[r].split(":nth-child")[0]),a[r]!==n[r]&&a[r].includes(".")&&(a[r]=a[r].split(".")[0]),a[r]!==n[r]&&a[r].includes("#")&&(a[r]=a[r].split("#")[0]);return a.join(">")}(e.cssSelector,t.cssSelector),r=function(e,t){for(let a=e.length-1;a>=0;a--){const n=e[a],r=t[a];n.attrs.forEach(e=>{e.checked=!1;const t=r.attrs.find(t=>t.name===e.name);t||(e.value=""),t&&"id"===t.name&&e.value===t.value&&""!==e.value&&(e.checked=!0),t&&"index"===t.name&&""!==e.value&&String(e.value)===String(t.value)&&(e.checked=!0),t&&"innertext"===t.name&&(e.checked=!1,e.value="")});n.attrs.some(e=>"id"===e.name&&e.checked)&&n.attrs.forEach(e=>{"id"!==e.name&&(e.checked=!1)})}return e}(e.pathDirs,t.pathDirs);return{...e,xpath:a,cssSelector:n,pathDirs:r}}const n=devicePixelRatio||1,r="jpeg";async function captureFullPage(t){let a;if("$firefox$"===e.getNavigatorUserAgent())return a=await function(e){return new Promise(t=>{chrome.tabs.sendMessage(e.id,{key:"fullPageRect",data:{}},{frameId:0},a=>{browser.tabs.captureTab(e.id,{format:r,quality:92,rect:a}).then(e=>{t(e)})})})}(t),a;await attach(t.id,null,t),await enablePage(t.id),await setBg(t.id,{color:{r:255,g:255,b:255,a:1}});const{cssContentSize:{width:i,height:s}}=await(c=t.id,new Promise(e=>{chrome.debugger.sendCommand({tabId:c},"Page.getLayoutMetrics",{},e)}));var c;return await function(e,{height:t,width:a}){return new Promise(r=>{chrome.debugger.sendCommand({tabId:e},"Emulation.setDeviceMetricsOverride",{height:t,width:a,deviceScaleFactor:n,mobile:!1},r)})}(t.id,{height:s,width:i}),await sleep(500),a=await screenshot(t.id,{x:0,y:0,width:i,height:s}),await sleep(500),await clearSize(t.id),await detach(t.id),a}function clearSize(e){return new Promise(t=>{chrome.debugger.sendCommand({tabId:e},"Emulation.clearDeviceMetricsOverride",t)})}function screenshot(e,t){return new Promise((a,i)=>{chrome.debugger.sendCommand({tabId:e},"Page.captureScreenshot",{format:r,fromSurface:!0,quality:92,clip:{...t,scale:n}},e=>{if(chrome.runtime.lastError)i(chrome.runtime.lastError);else{const t=`data:image/${r};base64,${e.data}`;a(t)}})})}function setBg(e,t){return new Promise(a=>{chrome.debugger.sendCommand({tabId:e},"Emulation.setDefaultBackgroundColorOverride",t,a)})}function enablePage(e){return new Promise(t=>{chrome.debugger.sendCommand({tabId:e},"Page.enable",{},()=>{t(e)})})}function attach(e,t,a){return new Promise((t,n)=>{"complete"===a.status&&chrome.debugger.attach({tabId:e},"1.0",()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(a||{id:e})})})}function detach(e){return new Promise(t=>{chrome.debugger.detach({tabId:e},()=>{setTimeout(()=>{t(e)},3e3)})})}function sleep(e){return new Promise(t=>setTimeout(t,e))}async function captureArea(e,t){const a=await function(e){return new Promise(t=>{chrome.tabs.sendMessage(e.id,{key:"getDPR",data:{}},{frameId:0},e=>{"number"==typeof e.dpr?t(e.dpr):t(1)})})}(e);t={x:t.x/a,y:t.y/a,width:t.width/a,height:t.height/a},await attach(e.id,0,e),await enablePage(e.id),await setBg(e.id,{color:{r:255,g:255,b:255,a:1}}),await sleep(3e3);const n=await screenshot(e.id,t);return await clearSize(e.id),await detach(e.id),await sleep(1e3),n}const i={query:e=>new Promise(t=>{chrome.tabs.query(e,e=>{t(e)})}),create:e=>(e.url||(e.url="about:blank"),new Promise(t=>{chrome.tabs.create(e,e=>{t(e)})})),update:(e,t)=>new Promise(a=>{chrome.tabs.update(e,t,e=>{a(e)})}),get:e=>new Promise(t=>{chrome.tabs.get(e,e=>{t(e)})}),reload:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.reload(t.id,{bypassCache:!0},()=>{e(!0)})})}),stopLoad:()=>new Promise(e=>{i.getActiveTab().then(t=>{i.sendTabMessage(t.id,{key:"stopLoad",data:{key:"stopLoad",data:{}}}).then(t=>{e(t)})})}),goForward:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.goForward(t.id,()=>{e(!0)})})}),goBack:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.goBack(t.id,()=>{e(!0)})})}),remove:e=>new Promise(t=>{chrome.tabs.remove(e,()=>{t(!0)})}),getZoom:e=>new Promise(t=>{chrome.tabs.getZoom(e,e=>{t(e)})}),executeScriptOnFrame:(e,t,a)=>new Promise((n,r)=>{const s={frameId:t,code:a,matchAboutBlank:!0};chrome.tabs.executeScript(e,s,s=>{console.log("executeScriptOnFrame:",t,a,s),s&&null!==s[0]||(i.sendTabFrameMessage(e,window.contentJS,t).then(e=>{console.log(t," iframe 加载注入contentJS结果:",e)}),r(new Error("executeScriptOnFrame error"))),chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):Array.isArray(s)&&1==s.length?n(s[0]):r(new Error(`unknown error: fail to execute script on ${t}`))})}),getAllTabs:()=>new Promise(e=>{chrome.tabs.query({},t=>{e(t)})}),reloadAllTabs:()=>{i.getAllTabs().then(e=>{for(const t of e)t.url&&!t.url.startsWith("chrome://")&&chrome.tabs.reload(t.id)})},urlGetTab:t=>new Promise((a,n)=>{chrome.tabs.query({},r=>{const s=r.find(a=>e.isEndWithSlash(a.url)&&!e.isEndWithSlash(t)?a.url===t+"/":a.url===t);s?i.activeTargetTab(s.id).then(e=>{a(e)}):n(new Error("Tab not found"))})}),getTab:e=>new Promise((t,a)=>{i.getActiveTab().then(a=>{a.url===e?t(a):i.urlGetTab(e).then(e=>{t(e)},()=>{i.openTab(e).then(e=>{t(e)})})})}),getActiveTab:()=>new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},t=>{e(t[0])})}),activeTargetTab:e=>new Promise(t=>{chrome.tabs.update(e,{active:!0},e=>{t(e)})}),activeTargetTabByTabUrl:e=>new Promise(t=>{chrome.tabs.query({url:e},a=>{a&&a[0]?chrome.tabs.update(a[0].id,{active:!0,highlighted:!0,selected:!0},e=>{t(e)}):chrome.tabs.create({url:e},e=>{t(e)})})}),switchTab:(e,t,a)=>new Promise(n=>{a?i.activeTargetTab(a).then(e=>{n(e)}):chrome.tabs.query({url:e,title:t},e=>{e&&e[0]?i.activeTargetTab(e[0].id).then(e=>{n(e)}):n(null)})}),openTab:e=>new Promise(t=>{chrome.tabs.create({url:e},e=>{t(e)})}),closeTab:e=>new Promise(t=>{chrome.tabs.remove(e,()=>{t(!0)})}),excuteTabScript:(e,t)=>new Promise(a=>{chrome.tabs.executeScript(e,{code:t},e=>{a(e)})}),getAllFrames:t=>new Promise(a=>{chrome.webNavigation.getAllFrames({tabId:t},n=>{const r=n.filter(t=>e.isSupportProtocal(t.url)),s=r.map((e,a)=>i.executeScriptOnFrame(t,r[a].frameId,'window.handleSync({ key: "getFrameInfo", data: {} })').then(t=>{r[a]={...e,...t}}).catch(t=>{console.error(`Error executing script on frame ${e.frameId}:`,t)}));Promise.all(s).then(()=>a(r))})}),getExtFrames:e=>new Promise(t=>{chrome.webNavigation.getAllFrames({tabId:e},e=>{t(e)})}),sendTabFrameMessage:(e,t,a)=>new Promise((n,r)=>{try{chrome.tabs.sendMessage(e,t,{frameId:a},e=>{n(e)})}catch(i){r(i)}}),sendTabMessage:(e,t)=>new Promise(a=>{chrome.tabs.sendMessage(e,t,{},e=>{a(e)})}),sendMessage:e=>new Promise(t=>{i.getAllTabs().then(a=>{a.forEach(a=>{chrome.tabs.sendMessage(a.id,e,{},e=>{t(e)})})})}),getUrl:()=>new Promise(e=>{i.getActiveTab().then(t=>{e(t.url)})}),getTitle:()=>new Promise(e=>{i.getActiveTab().then(t=>{e(t.title)})}),captureScreen:()=>new Promise(e=>{i.getActiveTab().then(t=>{chrome.tabs.captureVisibleTab(t.windowId,{format:"jpeg",quality:80},t=>{e(t)})})}),capturePage:async()=>new Promise(e=>{i.getActiveTab().then(t=>{captureFullPage(t).then(t=>{e(t)})})}),captureElement:async e=>new Promise(t=>{i.getActiveTab().then(a=>{captureArea(a,e).then(e=>{t(e)})})}),resetZoom:e=>new Promise(t=>{chrome.tabs.setZoom(e,1,()=>{t(!0)})})},WindowControl_getCurrent=()=>new Promise(e=>{chrome.windows.getCurrent(null,t=>{e(t)})}),WindowControl_update=(e,t)=>new Promise(a=>{chrome.windows.update(e,t,e=>{a(e)})});function findFrameByUrl(e,t){return e.find(e=>e.url.includes(t))}function findFrameByXpath(e,t){const a=t.split("/$iframe$"),n=e.find(e=>0===e.frameId);return a.reduce((t,a)=>{const n=e.find(e=>e.iframeXpath===a&&e.parentFrameId===t.frameId);return t&&n},n)}function adjustRectPosition(e,t){e.x+=t.x,e.y+=t.y,e.left=e.x,e.top=e.y,e.right=e.x+e.width,e.bottom=e.y+e.height}async function findTabAndFrame(e){const{url:t,iframeXpath:a,isFrame:n,tabUrl:r}=e.data;let s=await i.getActiveTab();if(!s&&(s=await i.activeTargetTabByTabUrl(r),!s))throw new Error("未找到活动标签页");if(n&&a){const e=await i.getAllFrames(s.id),n=a?findFrameByXpath(e,a):findFrameByUrl(e,t);return n?{tab:s,frameId:n.frameId}:{tab:s,frameId:-1}}return{tab:s,frameId:0}}window.activeElement=null;const s={version:"5.1.7",tabsHandler:()=>({async reloadTab(t){const a=await i.reload();return e.success(a)},async stopLoad(){const t=await i.stopLoad();return e.success(t)},async openNewTab(t){const a=await i.create(t.data);return e.success(a)},async closeTab(t){let a,{url:n,id:r}=t.data;if(r&&"number"!=typeof r){try{if(r=parseInt(r,10),isNaN(r))return e.fail("id 必须是数字")}catch(s){return e.fail("id 必须是数字")}return await i.remove(r),e.success(!0)}return n&&(a=await i.getTab(n)),a||(a=await i.getActiveTab()),a?(await i.remove(a.id),e.success(!0)):e.fail("tab not found")},async updateTab(t){const{url:a}=t.data;let n=await i.getActiveTab();return n?(await i.update(n.id,{url:a}),e.success(!0)):e.fail("tab not found")},async activeTab(t){const{url:a}=t.data,n=await i.getTab(a);return await i.activeTargetTab(n.id),e.success(!0)},async getActiveTab(){const t=await i.getActiveTab();return t?e.success(t):e.fail("未找到活动标签页")},async switchTab(t){let{url:a,title:n,id:r}=t.data;if(r&&"number"!=typeof r)try{if(r=parseInt(r,10),isNaN(r))return e.fail("id 必须是数字")}catch(c){return e.fail("id 必须是数字")}const s=await i.switchTab(a,n,r);return s?e.success(s):e.fail("未找到标签页")},async getAllTabs(){const t=await i.getAllTabs();return e.success(t)},async backward(t){const a=await i.goBack();return e.success(a)},async forward(t){const a=await i.goForward();return e.success(a)},async maxWindow(){const t=await WindowControl_getCurrent();if(await WindowControl_update(t.id,{state:"maximized"}))return e.success(!0);const{lastError:a}=chrome.runtime;return a?e.fail(a.message,"5003"):void 0},async minWindow(){const t=await WindowControl_getCurrent();if(await WindowControl_update(t.id,{state:"minimized"}))return e.success(!0);const{lastError:a}=chrome.runtime;return a?e.fail(a.message,"5003"):void 0},async executeScriptOnFrame(t){const{url:a,code:n}=t.data,r=await i.getActiveTab();if(!r)return e.fail("未找到活动标签页");const s=(await i.getAllFrames(r.id)).find(e=>e.url===a);if(s){const t=await i.executeScriptOnFrame(r.id,s.frameId,n);if(t)return e.success(t);{const{lastError:t}=chrome.runtime;if(t)return e.fail(t.message,"5003")}}else{const t=await i.executeScriptOnFrame(r.id,0,n);if(t)return e.success(t);{const{lastError:t}=chrome.runtime;if(t)return e.fail(t.message,"5003")}}},async getTitle(){const t=await i.getTitle();return e.success(t)},async getUrl(){const t=await i.getUrl();return e.success(t)},async captureScreen(){const t=await i.captureScreen();if(t)return e.success(t)},async capturePage(){const t=await i.capturePage();if(t)return e.success(t)},async loadComplete(){const{lastError:t}=chrome.runtime,a=await i.getActiveTab();return a?t?e.fail(t.message,"5003"):"complete"===a.status?e.success(!0):e.success(!1):e.fail("未找到活动标签页")},async getFrames(){const t=await i.getActiveTab();if(!t)return e.fail("未找到活动标签页");return await i.getAllFrames(t.id)},async getExtFrames(){const t=await i.getActiveTab();if(!t)return e.fail("未找到活动标签页");return await i.getExtFrames(t.id)},async resetZoom(){const t=await i.getActiveTab();if(!t)return e.fail("未找到活动标签页");return await i.resetZoom(t.id)},async getTabId(){const t=await i.getActiveTab();return t?e.success(t.id):e.fail("未找到活动标签页")}}),elementHandler:()=>window.contentJS?{async getElement(t){let a=window.activeElement;if(a&&a.isFrame){const{x:n,y:r}=t.data;if(!n||!r)return e.success(a);const s=await async function(e,t){const a=await i.getActiveTab(),n=await i.getAllFrames(a.id);let r=JSON.parse(JSON.stringify(t)),s=n.find(e=>e.frameId===t.frameId);const c=[];for(;s;)c.unshift(s.frameId),s=n.find(e=>e.frameId===s.parentFrameId);const l=[];for(let o=0;o<c.length;o++){const t=await i.executeScriptOnFrame(a.id,c[o],`window.handleSync({\n              key: "getIframeElement",\n              data: { x: ${e.x}, y: ${e.y} }\n            })`);l.push(t);const{nextPos:n}=t;e.x=n.x,e.y=n.y}if(l.length>0){const e=l[l.length-1],a=e.xpath===t.xpath,n=e.url===t.url;return a&&n||(l[l.length-1]=r),l.forEach((e,t)=>{r.iframeXpath=0===t?e.xpath:`${r.iframeXpath}/$iframe$${e.xpath}`,e.iframeContentRect&&(r.rect.x+=e.iframeContentRect.x,r.rect.y+=e.iframeContentRect.y)}),r.rect.left=r.rect.x,r.rect.top=r.rect.y,r.rect.right=r.rect.x+r.rect.width,r.rect.bottom=r.rect.y+r.rect.height,r.iframeXpath=r.iframeXpath.split("/$iframe$").slice(0,-1).join("/$iframe$"),r}return t}({x:n,y:r},a);return e.success(s)}return e.success(a)},async handleInContent(t){const{tab:a,frameId:n}=await findTabAndFrame(t);if(!a)return e.fail("未找到活动标签页");if(!e.isSupportProtocal(a.url))return e.fail(`${a.url} 当前标签页不支持web拾取协议`);const r=await i.sendTabFrameMessage(a.id,t,n);return"0000"!==r.code?e.fail(r.msg,r.code):e.success(r.data)},async getElementPos(t){const{url:a,isFrame:n,iframeXpath:r,tabUrl:s}=t.data;let c=await i.getActiveTab();if(c||(c=await i.activeTargetTabByTabUrl(s)),!e.isSupportProtocal(c.url))return e.fail(`${c.url} 当前标签页不支持web拾取协议`);if(!n){const a=await i.sendTabFrameMessage(c.id,t,0);return e.result(a.data,a.msg,a.code)}const l=await i.getAllFrames(c.id);let o=r?findFrameByXpath(l,r):findFrameByUrl(l,a);if(!o)return e.fail("未找到元素对应的iframe","5002");const d=function(e,t){const a=[];for(;t;)a.unshift(t),t=e.find(e=>e.frameId===t.parentFrameId);return a}(l,o),u=await async function(e,t){const a=t.slice(0,-1).map((a,n)=>{const r=t[n+1];return i.executeScriptOnFrame(e,a.frameId,`window.handleSync({\n        key: "getFramePosition",\n        data: {\n          iframeXpath: '${r.iframeXpath}',\n          url: '${r.url}'\n        }\n      })`)});return(await Promise.all(a)).reduce((e,t)=>(e.x+=t.x,e.y+=t.y,e),{x:0,y:0})}(c.id,d),m=await i.sendTabFrameMessage(c.id,t,o.frameId);return"0000"!==m.code?e.fail(m.msg,m.code):(function(e,t){Array.isArray(e)?e.forEach(e=>adjustRectPosition(e,t)):adjustRectPosition(e,t)}(m.data.rect,u),e.success(m.data))},checkElement:async e=>await s.elementHandler().getElementPos(e),async scrollIntoView(e){var t;if(null==(t=e.data)?void 0:t.openSourcePage){const t=await i.getActiveTab();t&&t.url===e.data.tabUrl||await i.openTab(e.data.url)}return await s.elementHandler().handleInContent(e)},async similarElement(t){var a;let n=window.activeElement;const{tabUrl:r}=t.data;let c=await i.getActiveTab();if(!c)return e.fail("未找到活动标签页");c.url!==r&&(c=await i.getTab(r));try{if(!function(e,t){if(!e||!t)return!1;if(0===e.length||0===t.length)return!1;const a=e[0],n=t[0],r=a.attrs.find(e=>"id"===e.name&&e.checked&&""!==e.value),i=n.attrs.find(e=>"id"===e.name&&e.checked&&""!==e.value);return!(!r||!i)&&r.value===i.value}(t.data.pathDirs,n.pathDirs)){const e=await s.elementHandler().handleInContent({...t,key:"reSimilarElement",data:{...n,preData:t.data}});console.log("reSimilarElement result: ",e),e.data&&(t.data=e.data.preData,n=e.data,delete t.data.preData)}const r=getSimilarElement(t.data,n);if(r){const n=await s.elementHandler().handleInContent({...t,data:r});return r.similarCount=(null==(a=n.data)?void 0:a.similarCount)||0,e.success(r)}return e.fail("该元素不是相似元素","5002")}catch(l){return e.fail(l.toString(),"5003")}},elementFromSelect:async e=>await s.elementHandler().handleInContent(e),async elementIsRender(t){const{tab:a,frameId:n}=await findTabAndFrame(t);if(!a)return e.fail("未找到活动标签页");if(-1!==n){const r=await i.sendTabFrameMessage(a.id,t,n);return r?e.success(r.data):e.success(!1)}return e.success(!1)},async elementIsReady(t){const a=await i.getActiveTab(),{tab:n,frameId:r}=await findTabAndFrame(t);if(!n)return e.fail("未找到活动标签页");if(-1!==r){t.key="elementIsRender";const s=await i.sendTabFrameMessage(n.id,t,r),c="complete"===a.status;return s?e.success(s.data&&c):e.success(!1)}return e.success(!1)},async elementIsTable(t){t.data.xpath||(t.data=window.activeElement);const a={isTable:!!(await s.elementHandler().handleInContent(t)).data,...t.data};return e.success(a)},async tableDataBatch(t){var n;"xpath"in t.data||(t.data=window.activeElement);const r=await s.elementHandler().handleInContent(t),i=(null==(n=r.data)?void 0:n.values)||[],c=new a(r.data,i,"table").getTable();return e.success(c)},async tableColumnDataBatch(t){var n;"xpath"in t.data||(t.data=window.activeElement);const r=await s.elementHandler().handleInContent(t),i=(null==(n=r.data)?void 0:n.value)||[],c=new a(r.data,i,"similar").getTable();return e.success(c)},async similarBatch(t){var n;if("xpath"in t.data||(t.data=window.activeElement),"batchType"in t.data&&["similar","similarAdd"].includes(t.data.batchType)){const e=await s.elementHandler().similarElement(t);if("0000"!==e.code)return e;t.data=e.data}const r=await s.elementHandler().handleInContent(t),i=(null==(n=r.data)?void 0:n.value)||[],c=new a(r.data,i,"similar").getTable();return e.success(c)},async tableHeaderBatch(e){"xpath"in e.data||(e.data=window.activeElement);return await s.elementHandler().handleInContent(e)},simalarListBatch:async e=>await s.elementHandler().handleInContent(e),highLightColumn:async e=>await s.elementHandler().handleInContent(e),async getBatchData(t){var a;if(null==(a=t.data)?void 0:a.openSourcePage){const e=await i.getActiveTab();e&&e.url===t.data.tabUrl||await i.openTab(t.data.tabUrl)}if(await e.wait(3),t.data&&"similar"===t.data.produceType){t.key="simalarListBatch";return await s.elementHandler().simalarListBatch(t)}t.key="tableDataBatch";return await s.elementHandler().tableDataBatch(t)},async elementShot(t){var a;t.key="scrollToTop",await s.elementHandler().scrollToTop(t),await s.tabsHandler().resetZoom(),t.key="getElementPos";const n=await s.elementHandler().getElementPos(t),{x:r,y:c,width:l,height:o}=null==(a=n.data)?void 0:a.rect,d=await i.captureElement({x:r,y:c,width:l,height:o});return e.success(d)},async scrollToTop(t){const a=await s.elementHandler().handleInContent(t);return e.success(a)},async getSimilarIterator(t){var a,n;t.key="elementFromSelect";const r=(null==(a=t.data)?void 0:a.index)||0,i=(null==(n=t.data)?void 0:n.count)||1,c=await s.elementHandler().elementFromSelect(t);if(c.data&&Array.isArray(c.data)){if(r<c.data.length){let t=[c.data[r]];return t=r+i<=c.data.length?c.data.slice(r,r+i):c.data.slice(r),t=t.map((e,t)=>(e.index+=t,{...e,similarCount:c.data.length})),e.success(t)}return e.success([])}return e.fail("未找到相似元素")},async getRelativeElement(t){const{relativeOptions:a}=t.data;if(!a)return e.fail("关联元素参数错误");return await s.elementHandler().handleInContent(t)},async generateElement(t){const a=await i.getActiveTab();if(!a)return e.fail("未找到活动标签页");return await i.sendTabFrameMessage(a.id,t,0)},clickElement:async e=>await s.elementHandler().handleInContent(e),inputElement:async e=>await s.elementHandler().handleInContent(e),getElementText:async e=>await s.elementHandler().handleInContent(e),getElementAttrs:async e=>await s.elementHandler().handleInContent(e),removeElementAttr:async e=>await s.elementHandler().handleInContent(e),setElementAttr:async e=>await s.elementHandler().handleInContent(e),getElementChecked:async e=>await s.elementHandler().handleInContent(e),setElementChecked:async e=>await s.elementHandler().handleInContent(e),getElementSelected:async e=>await s.elementHandler().handleInContent(e),setElementSelected:async e=>await s.elementHandler().handleInContent(e),getTableData:async e=>await s.elementHandler().handleInContent(e),scrollWindow:async e=>await s.elementHandler().handleInContent(e)}:e.fail("contentJS 未加载"),jsHandler:()=>({async runJS(t){const{tab:a,frameId:n}=await findTabAndFrame(t);if(!a)return e.fail("未找到活动标签页");if(-1!==n){return await i.sendTabFrameMessage(a.id,t,n)}return await i.sendTabMessage(a.id,t)}}),cookieHandler:()=>({...t}),otherHandler:()=>({currentExtension:()=>new Promise(e=>{chrome.management.getSelf(t=>{e(t)})})}),noHandler:()=>e.fail("暂不支持该功能，请升级插件！","5004")};window.Handlers=s,window.contentMessageHandler=function(e,t,a){if("element"===e.type&&t.tab){const a={tabTitle:t.tab.title,tabUrl:t.tab.url,isFrame:0!==t.frameId,frameId:t.frameId};window.activeElement={...e.data,...a}}return!0},window.bgHandler=async function(t){let a=null;const{key:n}=t,r=s;try{return r[n]?(a=await r[n](t),a):r.tabsHandler()[n]?(a=await r.tabsHandler()[n](t),a):r.elementHandler()[n]?(t.data&&"produceType"in t.data&&"similar"===t.data.produceType&&(t.data={...t.data,...t.data.values[0]}),a=await r.elementHandler()[n](t),a):r.jsHandler()[n]?(a=await r.jsHandler()[n](t),a):r.cookieHandler()[n]?(a=await r.cookieHandler()[n](t.data),a):r.otherHandler()[n]?(a=await r.otherHandler()[n](t.data),a):(a=r.noHandler(),a)}catch(i){return e.fail(i.toString(),"5003")}};
